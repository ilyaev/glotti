# Real-time Metrics Architecture Analysis

This document analyzes the current technical implementation of the live dashboard metrics (Filler Words, Words Per Minute, Tone, and Hints) during an active Glotti coaching session, and proposes ideas for improvement.

## Current Implementation

The real-time metrics are **not** generated by an LLM agent. They are calculated synchronously on the Node.js backend using a heuristic function (`extractMetrics`) inside `server/ws-handler.ts`.

### How it works:
1. **Audio Streaming:** The user's audio is sent via WebSocket to the Gemini Live API.
2. **Real-time Transcription:** Gemini Live returns a streaming text transcription of what the user is saying (`serverContent.inputTranscription.text`).
3. **Buffering:** `ws-handler.ts` buffers these transcription fragments.
4. **Trigger:** When the buffer detects a sentence boundary (punctuation like `.`, `?`, `!`) or exceeds 10 words, the sentence is considered "finished" and is flushed.
5. **Heuristic Calculation:** The `extractMetrics(allUserText, elapsedSeconds)` function is called against the *entire* concatenated user transcript up to that point.
    *   **Filler Words Check:** Uses a simple Regex match against a hardcoded array (`['um', 'uh', 'like', 'you know', ...]`) to count occurrences.
    *   **WPM Calculation:** Splits all user text by whitespace to get a total word count, then divides by the `elapsedSeconds / 60`.
    *   **Tone Detection:** Uses extreme keyword matching (e.g., if the text contains "sorry" or "maybe", tone = `nervous`; if it contains "!" or "confident", tone = `confident`).
6. **Delivery:** The resulting `MetricSnapshot` object is sent down to the React client via the WebSocket connection (`{ type: 'metrics', data: ... }`).
7. **Rendering:** The `Dashboard.tsx` component receives this state update and re-renders the metric cards.

## Strengths
- **Zero Latency:** Because it relies on simple Regex/Math instead of an LLM call, the dashboard metrics update instantly as soon as the transcript arrives from Gemini.
- **Low Cost:** No additional tokens are consumed to generate these metrics.
- **Simplicity:** Very easy to debug and extend with new hardcoded rules.

## Weaknesses
- **Inaccurate Tone Detection:** Keyword matching for emotion is highly inaccurate. Saying "I am absolutely NOT sorry" would currently trigger the `nervous` tone badge.
- **Language Lock:** The hardcoded filler words only work for English.
- **Rigid Hints:** The `improvement_hint` just mechanically tells the user to stop saying whatever filler word triggered the count first.

---

## Proposed Improvements & New Metrics

To make the dashboard significantly more valuable and engaging, we can implement the following:

### 1. Shift Tone Analysis to a Background LLM Worker
Instead of keyword matching, we should periodically (e.g. every 15 seconds) send the recent transcript chunk to a lightweight Gemini model (like `gemini-v1.5-flash`) specifically prompted to return a 1-word emotional state ("Confident", "Defensive", "Rambling", "Concise"). This will provide actual semantic tone analysis.

### 2. Add a "Talk-to-Listen Ratio" Metric
In scenarios like `EmpathyTrainer` or `PitchPerfect`, dominating the conversation is a negative trait.
*   **Implementation:** Track `userSpeakingSeconds` vs `aiSpeakingSeconds` locally in the client or server.
*   **Metric:** A percentage dial (e.g. `65% User / 35% AI`).
*   **Value:** Coaches the user to pause and let the other party speak.

### 3. Add an "Active Vocabulary" or "Clarity" Score
*   **Implementation:** Run a quick readability index (like Flesch-Kincaid) on the `allUserText` string, or count the uniqueness of words used (Total Unique Words / Total Words).
*   **Metric:** A score from 1-100 indicating how articulate and varied their vocabulary is, versus relying on the same generic phrases.

### 4. Dynamic "Live Coach" Hints
Instead of static filler word warnings, we could push contextual hints from the system prompt.
*   **Example (Veritalk):** Determine if the user hasn't asked a question in 2 minutes. Push hint: *"ğŸ’¡ Try flipping the defense: ask them a clarifying question."*
*   **Example (PitchPerfect):** If WPM > 180. Push hint: *"ğŸ’¡ You're speaking very fast. Take a breath and slow down."*
